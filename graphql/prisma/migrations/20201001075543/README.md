# Migration `20201001075543`

This migration has been generated by Kullanan at 10/1/2020, 2:55:43 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."Role" AS ENUM ('ADMIN', 'USER')

CREATE TABLE "public"."User" (
"id" SERIAL,
"email" text   NOT NULL ,
"name" text   ,
"image" text   ,
"position" text   ,
"skills" text []  ,
"contactId" integer   NOT NULL ,
"role" "Role"  NOT NULL DEFAULT E'USER',
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Contact" (
"id" SERIAL,
"facebook" text   ,
"twitter" text   ,
"instagram" text   ,
"gitlab" text   ,
"github" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Project" (
"id" SERIAL,
"projectName" text   ,
"projectType" text   ,
"projectDetail" text   ,
"projectImage" text   ,
"status" text   DEFAULT E'undone',
"dueDate" timestamp(3)   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."ProjectOnUser" (
"userId" integer   NOT NULL ,
"projectId" integer   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("userId","projectId")
)

CREATE TABLE "public"."Task" (
"id" SERIAL,
"projectId" integer   NOT NULL ,
"taskName" text   ,
"startTime" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"endTime" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"taskDetail" text   ,
"isDone" boolean   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."TaskOnUser" (
"userId" integer   NOT NULL ,
"taskId" integer   NOT NULL ,
"cretedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("userId","taskId")
)

CREATE TABLE "public"."File" (
"id" SERIAL,
"url" text   ,
"name" text   ,
"status" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."FileOnTask" (
"taskId" integer   NOT NULL ,
"fileId" integer   NOT NULL ,
"cretedAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("taskId","fileId")
)

CREATE TABLE "public"."Comment" (
"id" SERIAL,
"userId" integer   NOT NULL ,
"taskId" integer   NOT NULL ,
"timestamp" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"image" text   ,
"message" text   ,
"replyId" integer   ,
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "User.email_unique" ON "public"."User"("email")

CREATE UNIQUE INDEX "FileOnTask_fileId_unique" ON "public"."FileOnTask"("fileId")

ALTER TABLE "public"."User" ADD FOREIGN KEY ("contactId")REFERENCES "public"."Contact"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ProjectOnUser" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ProjectOnUser" ADD FOREIGN KEY ("projectId")REFERENCES "public"."Project"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Task" ADD FOREIGN KEY ("projectId")REFERENCES "public"."Project"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."TaskOnUser" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."TaskOnUser" ADD FOREIGN KEY ("taskId")REFERENCES "public"."Task"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."FileOnTask" ADD FOREIGN KEY ("taskId")REFERENCES "public"."Task"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."FileOnTask" ADD FOREIGN KEY ("fileId")REFERENCES "public"."File"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Comment" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Comment" ADD FOREIGN KEY ("taskId")REFERENCES "public"."Task"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Comment" ADD FOREIGN KEY ("replyId")REFERENCES "public"."Comment"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200929071847..20201001075543
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model User {
   id        Int             @id @default(autoincrement())
@@ -15,9 +15,9 @@
   position  String?
   skills    String[]
   contacts  Contact         @relation(fields: [contactId], references: [id])
   contactId Int
-  comments  CommentOnUser[]
+  comments  Comment[]
   projects  ProjectOnUser[]
   tasks     TaskOnUser[]
   role      Role            @default(USER)
 }
@@ -49,31 +49,33 @@
   userId    Int
   project   Project  @relation(fields: [projectId], references: [id])
   projectId Int
   createdAt DateTime @default(now())
+
   @@id([userId, projectId])
 }
 model Task {
-  id         Int             @id @default(autoincrement())
-  project    Project         @relation(fields: [projectId], references: [id])
+  id         Int          @id @default(autoincrement())
+  project    Project      @relation(fields: [projectId], references: [id])
   projectId  Int
   taskName   String?
-  startTime  DateTime        @default(now())
-  endTime    DateTime        @default(now())
+  startTime  DateTime     @default(now())
+  endTime    DateTime     @default(now())
   taskDetail String?
   isDone     Boolean
   members    TaskOnUser[]
   files      FileOnTask[]
-  comments   CommentOnTask[]
+  comments   Comment[]
 }
 model TaskOnUser {
   user     User     @relation(fields: [userId], references: [id])
   userId   Int
   task     Task     @relation(fields: [taskId], references: [id])
   taskId   Int
   cretedAt DateTime @default(now())
+
   @@id([userId, taskId])
 }
 model File {
@@ -89,38 +91,43 @@
   taskId   Int
   file     File     @relation(fields: [fileId], references: [id])
   fileId   Int
   cretedAt DateTime @default(now())
+
   @@id([taskId, fileId])
 }
 model Comment {
-  id        Int             @id @default(autoincrement())
-  users     CommentOnUser[]
-  task      CommentOnTask
-  timestamp DateTime        @default(now())
-  image     String?
-  message   String?
-}
-
-model CommentOnUser {
+  id        Int      @id @default(autoincrement())
   user      User     @relation(fields: [userId], references: [id])
   userId    Int
-  comment   Comment  @relation(fields: [commentId], references: [id])
-  commentId Int
-  cretedAt  DateTime @default(now())
-  @@id([userId, commentId])
-}
-
-model CommentOnTask {
   task      Task     @relation(fields: [taskId], references: [id])
   taskId    Int
-  comment   Comment  @relation(fields: [commentId], references: [id])
-  commentId Int
-  cretedAt  DateTime @default(now())
-  @@id([taskId, commentId])
+  timestamp DateTime @default(now())
+  image     String?
+  message   String?
+  replyId   Int?
+  reply     Comment? @relation("ReplyComment", fields: [replyId], references: [id])
 }
+// model CommentOnUser {
+//   user      User     @relation(fields: [userId], references: [id])
+//   userId    Int
+//   comment   Comment  @relation(fields: [commentId], references: [id])
+//   commentId Int
+//   cretedAt  DateTime @default(now())
+//   @@id([userId, commentId])
+// }
+
+// model CommentOnTask {
+//   task      Task     @relation(fields: [taskId], references: [id])
+//   taskId    Int
+//   comment   Comment  @relation(fields: [commentId], references: [id])
+//   commentId Int
+//   cretedAt  DateTime @default(now())
+//   @@id([taskId, commentId])
+// }
+
 enum Role {
   ADMIN
   USER
 }
```


